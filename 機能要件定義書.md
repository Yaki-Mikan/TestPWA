# GeminiPWA 機能要件定義書

## 目次

1. [システム概要](#1-システム概要)
2. [コア機能](#2-コア機能)
3. [API連携](#3-api連携)
4. [データ管理](#4-データ管理)
5. [UI/UX機能](#5-uiux機能)
6. [高度な機能](#6-高度な機能)
7. [メディア対応](#7-メディア対応)
8. [PWA機能](#8-pwa機能)
9. [その他の機能](#9-その他の機能)
10. [非機能要件](#10-非機能要件)

---

## 1. システム概要

### 1.1 アプリケーション基本情報

- **アプリケーション名**: GeminiPWA
- **種類**: Progressive Web Application (PWA)
- **アーキテクチャ**: Single Page Application (SPA)
- **技術スタック**:
  - HTML5
  - CSS3
  - JavaScript (Vanilla / ES6+)
  - IndexedDB
  - Service Worker
  - marked.js (Markdown parser)
  - DOMPurify (XSS sanitizer)

### 1.2 アプリケーション特性

- 完全クライアントサイド実行（サーバーサイド処理不要、静的ファイルホスティングのみで動作）
- 全データをブラウザのIndexedDBにローカル保存（サーバーへのデータ送信なし）
- ビルドプロセス不要（単一HTMLファイル構成）
- 日本語UIを標準装備
- 複数AIプロバイダー対応
- 約17,000行の単一HTMLファイルで実装

### 1.3 デプロイメント

- **本番環境**: GitHub Pages等の静的ホスティングサービスで動作
- **開発環境**: ローカルHTTPサーバーが必要（PWAやService Workerは`file://`プロトコルでは動作しないため）
  - Windows: `__winlocal.bat`を実行してローカルサーバー起動（ポート8072）
  - その他: 任意のHTTPサーバー（Python `http.server`, Node.js `http-server`等）
- **スマートフォン対応**: GitHub Pagesにデプロイすればスマートフォンのブラウザから直接アクセス可能

### 1.4 主要なグローバルオブジェクト

| オブジェクト名 | 役割 |
|--------------|------|
| `state` | アプリケーション状態管理（現在のメッセージ、設定、セッション情報など約200個のプロパティ） |
| `dbUtils` | IndexedDB操作（CRUD操作、設定の永続化） |
| `uiUtils` | UI操作とレンダリング（Markdown解析、テーマ適用、メッセージ表示） |
| `apiModule` | 各AIプロバイダーとのAPI通信 |
| `eventHandlers` | ユーザーインタラクションの処理 |

---

## 2. コア機能

### 2.1 基本チャット機能

#### 2.1.1 メッセージ送信

**要件ID**: CORE-001

**機能概要**:
AIとのテキストベースの会話を実現する基本機能。

**詳細仕様**:

- **入力方法**:
  - テキストエリアでの入力
  - Enterキーでの送信（設定により有効/無効切替可能）
  - 送信ボタンのクリック

- **添付ファイル対応**:
  - 画像ファイル（PNG, JPEG, GIF, WEBP等）
  - その他のファイル（モデル対応による）
  - Gemini等のマルチモーダルモデルで利用可能

- **状態管理**:
  - `state.currentMessages`配列でメッセージを管理
  - 各メッセージは以下の構造を持つ:
    ```javascript
    {
      role: "user" | "model",
      parts: [{ text: "メッセージ内容" }],
      attachments: [...], // 添付ファイル（Base64）
      timestamp: Date
    }
    ```

**関連設定項目**:
- `enterToSend`: Enterキーで送信（Boolean）
- `autoScrollOnNewMessage`: 新規メッセージ時の自動スクロール（Boolean）

---

#### 2.1.2 メッセージ表示

**要件ID**: CORE-002

**機能概要**:
AIからの応答やユーザーメッセージを適切にレンダリングして表示。

**詳細仕様**:

- **Markdown対応**:
  - marked.jsライブラリを使用してMarkdownを解析
  - 対応要素: 見出し（h1-h6）、段落、強調、リスト、ブロッククォート、コードブロック、リンク、テーブル、水平線、画像

- **サニタイズ**:
  - DOMPurifyでXSS攻撃を防止
  - 安全なHTMLのみを許可

- **コードブロック**:
  - シンタックスハイライト対応
  - 言語指定に応じた色付け
  - コピーボタンを各コードブロックに配置

- **Mermaid図**:
  - Mermaid形式のダイアグラムを自動レンダリング
  - 折りたたみ・展開機能

- **画像表示**:
  - Markdown内の画像を表示
  - 添付画像のプレビュー表示

**関連設定項目**:
- `messageBodyFontSize`: メッセージフォントサイズ（1-100px）
- `codeBlockFontSize`: コードブロックフォントサイズ（1-100px）

---

#### 2.1.3 ストリーミング表示

**要件ID**: CORE-003

**機能概要**:
AIからの応答をリアルタイムで表示。

**詳細仕様**:

- **Server-Sent Events (SSE)対応**:
  - リアルタイムで応答チャンクを受信
  - 文字単位で段階的に表示

- **文字送り速度制御**:
  - ミリ秒/文字で速度を設定可能
  - 0に設定すると即座に表示

- **疑似ストリーミング（Gemini専用）**:
  - 一括生成後にストリーミング風に再生
  - レスポンスが一度に返ってくるモデルでもストリーミング体験を提供

**関連設定項目**:
- `{provider}StreamingOutput`: ストリーミング有効化（Boolean）
- `{provider}StreamingSpeed`: 文字送り速度（Number, ミリ秒/文字）

---

### 2.2 セッション管理

#### 2.2.1 マルチセッション対応

**要件ID**: CORE-004

**機能概要**:
複数の独立したチャット履歴を管理し、切り替えることができる。

**詳細仕様**:

- **セッション作成**:
  - 「新規チャット」ボタンで作成
  - メッセージ送信時に自動保存
  - データ構造:
    ```javascript
    {
      id: Number, // 自動採番ID
      messages: Array, // メッセージ配列
      createdAt: Date, // 作成日時
      updatedAt: Date  // 更新日時
    }
    ```

- **セッション切替**:
  - 履歴画面からセッション一覧を表示して選択
  - スワイプナビゲーション（左右スワイプで前後のセッションに移動）
  - 送信中の切替時に確認ダイアログ表示（設定可能）

- **ソート順**:
  - 更新日時順（新しい順）
  - 作成日時順（新しい順）

**関連設定項目**:
- `enableSwipeNavigation`: スワイプナビゲーション有効化（Boolean）
- `disableLoadChatConfirmationWhileSending`: 送信中の読み込み確認無効化（Boolean）
- `historySortOrder`: ソート順（"updatedAt" | "createdAt"）

---

#### 2.2.2 セッション操作

**要件ID**: CORE-005

**機能概要**:
セッションの複製、削除、エクスポート、インポート機能。

**詳細仕様**:

- **複製**: セッション全体をコピーして新規セッションとして作成
- **削除**: 確認ダイアログ後にセッションを削除
- **エクスポート**:
  - JSON形式でテキストファイルとして出力
  - 単一セッションまたは全セッション一括エクスポート可能
- **インポート**:
  - JSON形式のファイルまたはテキストから読み込み
  - プレフィックス追加オプション（インポート元を識別しやすくする）
  - 単一セッションまたは複数セッション一括インポート可能
- **一括操作**:
  - 全セッション一括エクスポート
  - 全セッション一括インポート
  - 全セッション一括削除

**関連設定項目**:
- `addPrefixOnImport`: インポート時にプレフィックス追加（Boolean）
- `showBulkHistoryActions`: 一括履歴操作表示（Boolean）

---

### 2.3 メッセージ操作

#### 2.3.1 メッセージ編集

**要件ID**: CORE-006

**機能概要**:
個別メッセージの編集・再送信。

**詳細仕様**:

- **ユーザーメッセージの編集**:
  - テキストを編集可能
  - 編集後に再送信すると、そのメッセージ以降の履歴が削除され、新たにAI応答が生成される

- **AIメッセージの編集**:
  - AI応答内容を直接編集可能
  - 手動でセッションを構築する際に有用

**UI要素**:
- 各メッセージに「編集」ボタンを配置
- 編集モード時はテキストエリアに変換
- 「保存」「キャンセル」ボタンで確定/取消

---

#### 2.3.2 メッセージ削除

**要件ID**: CORE-007

**機能概要**:
個別メッセージの削除。

**詳細仕様**:

- **単一削除**: 指定したメッセージのみを削除
- **カスケード削除**: そのメッセージ以降の全メッセージを削除（デフォルト動作）
- **確認ダイアログ**: 設定により削除前に確認を表示

**関連設定項目**:
- `disableDeleteMessageConfirmation`: 削除確認無効化（Boolean）

---

#### 2.3.3 メッセージ再試行・複製

**要件ID**: CORE-008

**機能概要**:
AIの応答を再生成、またはメッセージを複製。

**詳細仕様**:

- **再試行**:
  - AIの応答を削除して再度生成
  - 確認ダイアログ表示（設定可能）

- **複製**:
  - メッセージを複製して編集
  - バリエーション作成に便利

**関連設定項目**:
- `disableRetryConfirmation`: 再試行確認無効化（Boolean）

---

#### 2.3.4 メッセージコピー

**要件ID**: CORE-009

**機能概要**:
メッセージ内容やコードブロックをクリップボードにコピー。

**詳細仕様**:

- **テキストコピー**: メッセージ本文全体をクリップボードにコピー
- **コードブロックコピー**: コードブロック単位で個別にコピー
- **クリップボードスタック連携**: コピーした内容をスタックに蓄積（オプション）

---

#### 2.3.5 メッセージ折りたたみ

**要件ID**: CORE-010

**機能概要**:
長いメッセージを折りたたんで表示領域を節約。

**詳細仕様**:

- **上部ボタン**: 縦長の「▲」「▼」ボタンでメッセージを折りたたみ/展開
- **下部ボタン**: テキストボタン（「折りたたむ」「展開する」等）で操作
- **状態保持**: 折りたたみ状態をセッションごとに記憶（設定可能）
- **一括操作**: 全メッセージを一括で表示/非表示切替

**関連設定項目**:
- `showTopCollapseButton`: 上部折りたたみボタン表示（Boolean）
- `showBottomCollapseButton`: 下部折りたたみボタン表示（Boolean）
- `persistMessageCollapseState`: 折りたたみ状態保持（Boolean）
- `showToggleAllContentButton`: 全メッセージ表示切替ボタン表示（Boolean）
- `toggleButtonTopWidth`: 上部ボタン幅（1-100px）
- `toggleButtonTopHeight`: 上部ボタン高さ（1-100px）
- `toggleButtonTopFontSize`: 上部ボタンフォントサイズ（1-50px）
- `toggleButtonTopOpacity`: 上部ボタン透明度（0-1）
- `toggleButtonTopTextCollapse`: 折りたたみ時テキスト（String）
- `toggleButtonTopTextExpand`: 展開時テキスト（String）
- `toggleButtonBottomFontSize`: 下部ボタンフォントサイズ（1-34px）
- `toggleButtonBottomTextCollapse`: 折りたたみ時テキスト（String）
- `toggleButtonBottomTextExpand`: 展開時テキスト（String）

---

## 3. API連携

### 3.1 対応プロバイダー

#### 3.1.1 Google Gemini API

**要件ID**: API-001

**機能概要**:
Google Gemini APIとの連携。

**詳細仕様**:

- **デフォルトモデル**: `gemini-2.0-flash-exp`
- **特徴**:
  - ファイル・画像解析対応（マルチモーダル）
  - Groundingモード（検索拡張生成）
  - 思考プロセス表示対応
  - 疑似ストリーミングモード

- **パラメータ**:
  - `temperature`: 温度（0-2）
  - `maxTokens`: 最大トークン数
  - `topK`: Top-K
  - `topP`: Top-P（0-1）
  - `presencePenalty`: プレゼンスペナルティ（-2.0~2.0）
  - `frequencyPenalty`: 頻度ペナルティ（-2.0~2.0）
  - `thinkingBudget`: 思考予算
  - `includeThoughts`: 思考プロセスを含む（Boolean）
  - `expandThoughtsByDefault`: 思考プロセスをデフォルトで展開（Boolean）
  - `enableGrounding`: Groundingを有効化（Boolean）

**関連設定項目**:
- `geminiApiKeys`: APIキー配列
- `geminiActiveApiKeyIndex`: アクティブキーインデックス
- `geminiSystemPrompt`: システムプロンプト
- `geminiEnableSystemPromptDefault`: システムプロンプトをデフォルト有効化
- 各パラメータに対応する設定項目（`geminiTemperature`, `geminiMaxTokens`等）

---

#### 3.1.2 DeepSeek API

**要件ID**: API-002

**機能概要**:
DeepSeek APIとの連携。

**詳細仕様**:

- **デフォルトモデル**: `deepseek-chat`
- **特徴**:
  - 思考プロセス（reasoning content）表示対応
  - カスタムエンドポイント設定可能

- **パラメータ**:
  - `temperature`: 温度
  - `maxTokens`: 最大トークン数
  - `topP`: Top-P
  - `presencePenalty`: プレゼンスペナルティ
  - `frequencyPenalty`: 頻度ペナルティ
  - `includeDeepSeekThoughts`: DeepSeek思考プロセスを含む（Boolean）
  - `expandThoughtsByDefault`: 思考プロセスをデフォルトで展開（Boolean）

**関連設定項目**:
- `deepseekApiKeys`: APIキー配列
- `deepseekActiveApiKeyIndex`: アクティブキーインデックス
- `deepseekSystemPrompt`: システムプロンプト
- `deepseekEnableSystemPromptDefault`: システムプロンプトをデフォルト有効化
- 各パラメータに対応する設定項目

---

#### 3.1.3 Anthropic Claude API

**要件ID**: API-003

**機能概要**:
Anthropic Claude APIとの連携。

**詳細仕様**:

- **デフォルトモデル**: `claude-3-5-sonnet-20241022`
- **特徴**:
  - Extended Thinking対応
  - 思考プロセス表示

- **パラメータ**:
  - `temperature`: 温度
  - `maxTokens`: 最大トークン数
  - `topK`: Top-K
  - `topP`: Top-P
  - `includeThoughts`: 思考プロセスを含む（Boolean）
  - `expandThoughtsByDefault`: 思考プロセスをデフォルトで展開（Boolean）
  - `thinkingBudget`: 思考予算

**関連設定項目**:
- `claudeApiKeys`: APIキー配列
- `claudeActiveApiKeyIndex`: アクティブキーインデックス
- `claudeSystemPrompt`: システムプロンプト
- `claudeEnableSystemPromptDefault`: システムプロンプトをデフォルト有効化
- 各パラメータに対応する設定項目

---

#### 3.1.4 OpenAI API

**要件ID**: API-004

**機能概要**:
OpenAI APIとの連携。

**詳細仕様**:

- **デフォルトモデル**: `gpt-4o`
- **パラメータ**:
  - `temperature`: 温度
  - `maxTokens`: 最大トークン数
  - `topP`: Top-P
  - `presencePenalty`: プレゼンスペナルティ
  - `frequencyPenalty`: 頻度ペナルティ

**関連設定項目**:
- `openaiApiKeys`: APIキー配列
- `openaiActiveApiKeyIndex`: アクティブキーインデックス
- `openaiSystemPrompt`: システムプロンプト
- `openaiEnableSystemPromptDefault`: システムプロンプトをデフォルト有効化
- 各パラメータに対応する設定項目

---

#### 3.1.5 xAI (Grok) API

**要件ID**: API-005

**機能概要**:
xAI (Grok) APIとの連携。

**詳細仕様**:

- **デフォルトモデル**: `grok-2-1212`
- **特徴**:
  - 思考プロセス対応
  - Vision機能（画像認識）
  - 推論努力レベル設定

- **パラメータ**:
  - `temperature`: 温度
  - `maxTokens`: 最大トークン数
  - `topP`: Top-P
  - `presencePenalty`: プレゼンスペナルティ
  - `frequencyPenalty`: 頻度ペナルティ
  - `visionEnable`: Vision機能有効化（Boolean）
  - `includeThoughts`: 思考プロセスを含む（Boolean）
  - `expandThoughtsByDefault`: 思考プロセスをデフォルトで展開（Boolean）
  - `reasoningEffort`: 推論努力レベル（"low" | "medium" | "high"）

**関連設定項目**:
- `xaiApiKeys`: APIキー配列
- `xaiActiveApiKeyIndex`: アクティブキーインデックス
- `xaiSystemPrompt`: システムプロンプト
- `xaiEnableSystemPromptDefault`: システムプロンプトをデフォルト有効化
- 各パラメータに対応する設定項目

---

#### 3.1.6 LLM Aggregator (OpenRouter等)

**要件ID**: API-006

**機能概要**:
OpenRouter、Together.ai、Fireworks等のLLMアグリゲーターとの連携。

**詳細仕様**:

- **デフォルトモデル**: `anthropic/claude-3.5-sonnet:beta`
- **特徴**:
  - カスタムバックエンドURL設定
  - ドメイン制限（セキュリティ）

- **パラメータ**:
  - `apiBackend`: バックエンドURL
  - `temperature`: 温度
  - `maxTokens`: 最大トークン数
  - `topP`: Top-P
  - `topK`: Top-K
  - `presencePenalty`: プレゼンスペナルティ
  - `frequencyPenalty`: 頻度ペナルティ
  - `includeThoughts`: 思考プロセスを含む（Boolean）
  - `expandThoughtsByDefault`: 思考プロセスをデフォルトで展開（Boolean）

**関連設定項目**:
- `llmaggregatorApiKeys`: APIキー配列
- `llmaggregatorActiveApiKeyIndex`: アクティブキーインデックス
- `llmaggregatorSystemPrompt`: システムプロンプト
- `llmaggregatorEnableSystemPromptDefault`: システムプロンプトをデフォルト有効化
- 各パラメータに対応する設定項目

---

#### 3.1.7 Dummy AI

**要件ID**: API-007

**機能概要**:
空の応答を返す疑似AI（テスト・デバッグ用）。

**詳細仕様**:

- **用途**:
  - 手動でセッション構築
  - UI動作のテスト
  - デバッグモード

- **デバッグモード**:
  - `errorDebugMode`: エラーメッセージをそのまま応答として返す
  - `twinEngineDebugMode`: Twin-Engine用プロンプトを応答として返す

**関連設定項目**:
- `dummyErrorDebugMode`: エラーデバッグモード（Boolean）
- `dummyTwinEngineDebugMode`: Twin-Engineデバッグモード（Boolean）

---

### 3.2 API認証・管理

#### 3.2.1 複数APIキー管理

**要件ID**: API-008

**機能概要**:
プロバイダーごとに複数のAPIキーを登録・切替。

**詳細仕様**:

- **保存形式**: 各プロバイダーごとにAPIキー配列として保存
- **切替**: アクティブなキーのインデックスで管理
- **セキュリティ**: IndexedDBにローカル保存のみ、サーバーへの送信なし

**UI要素**:
- 設定画面でキー追加・削除・切替
- アクティブなキーをハイライト表示

**関連設定項目**:
- `showMultiApiKeys`: 複数APIキー設定表示（Boolean）
- `{provider}ApiKeys`: 各プロバイダーのAPIキー配列
- `{provider}ActiveApiKeyIndex`: アクティブキーインデックス

---

#### 3.2.2 プロバイダー切替

**要件ID**: API-009

**機能概要**:
使用するAIプロバイダーを簡単に切り替え。

**詳細仕様**:

- **切替方法**:
  - ヘッダーのプロバイダートグルボタン
  - フッターのプロバイダートグルボタン
  - 設定画面

- **サイクル設定**: トグルボタンでサイクルするプロバイダーをカスタマイズ可能

- **UI**: プロバイダーごとに色分け表示（Gemini=紫、DeepSeek=青等）

**関連設定項目**:
- `apiProvider`: 使用プロバイダー（"gemini" | "deepseek" | "claude" | "openai" | "xai" | "llmaggregator" | "dummy"）
- `showApiProviderToggleHeader`: ヘッダーにボタン表示（Boolean）
- `showApiProviderToggleFooter`: フッターにボタン表示（Boolean）
- `apiProviderCycle`: サイクルに含めるプロバイダー設定（Array）

---

### 3.3 共通・高度なAPI設定

#### 3.3.1 システムプロンプト

**要件ID**: API-010

**機能概要**:
AIに対する指示をシステムプロンプトとして設定。

**詳細仕様**:

- **共通プロンプト**: 全プロバイダーに適用されるシステムプロンプト
- **プロバイダー固有プロンプト**: 各プロバイダー専用のプロンプト
- **デフォルト有効化**: 各プロバイダーでON/OFF切替可能

**関連設定項目**:
- `commonSystemPrompt`: 共通システムプロンプト（String）
- `enableCommonSystemPromptDefault`: 共通プロンプトをデフォルトで有効化（Boolean）
- `{provider}SystemPrompt`: 各プロバイダーのシステムプロンプト（String）
- `{provider}EnableSystemPromptDefault`: プロバイダープロンプトをデフォルトで有効化（Boolean）

---

#### 3.3.2 ダミープロンプト

**要件ID**: API-011

**機能概要**:
API送信直前に履歴に追加されるプロンプト。

**詳細仕様**:

- **Dummy User**: userロールとして履歴末尾に追加
- **Dummy Model**: modelロールとして履歴最末尾に追加
- **Concat Dummy Model**: Dummy Modelを連結するオプション
- **有効化**: 各プロバイダーでON/OFF設定

**用途**:
- 特定の出力形式を誘導
- 継続的な指示を挿入

**関連設定項目**:
- `{provider}DummyUser`: Dummy Userプロンプト（String）
- `{provider}EnableDummyUser`: Dummy User有効化（Boolean）
- `{provider}DummyModel`: Dummy Modelプロンプト（String）
- `{provider}EnableDummyModel`: Dummy Model有効化（Boolean）
- `{provider}ConcatDummyModel`: Dummy Model連結（Boolean）

---

#### 3.3.3 追加モデル

**要件ID**: API-012

**機能概要**:
デフォルト以外のモデルを追加して選択可能にする。

**詳細仕様**:

- **設定方法**: カンマ区切りでモデル名を入力
- **UI**: モデル選択ドロップダウンに追加表示

**関連設定項目**:
- `{provider}AdditionalModels`: 追加モデル（String, カンマ区切り）

---

#### 3.3.4 ストリーミング設定

**要件ID**: API-013

**機能概要**:
ストリーミング出力の有効化と速度調整。

**詳細仕様**:

- **有効化**: 各プロバイダーで個別設定
- **文字送り速度**: ミリ秒/文字で設定（0で無効）
- **疑似ストリーミング**: 一括生成後にストリーミング再生（Gemini専用）

**関連設定項目**:
- `{provider}StreamingOutput`: ストリーミング有効化（Boolean）
- `{provider}StreamingSpeed`: 文字送り速度（Number, ミリ秒/文字）

---

## 4. データ管理

### 4.1 IndexedDB

#### 4.1.1 データベース構造

**要件ID**: DATA-001

**機能概要**:
ブラウザ内でのデータ永続化。

**詳細仕様**:

- **データベース名**: `GeminiPWADB`
- **バージョン管理**: `DB_VERSION`定数で管理

- **オブジェクトストア**:

  1. **chats**:
     - 説明: チャットセッション保存
     - キー: `id`（自動採番）
     - インデックス: `updatedAt`, `createdAt`

  2. **settings**:
     - 説明: 設定保存
     - キー: `key`
     - 値: `value`

- **操作メソッド**:
  - `dbUtils.openDB()`: データベースオープン
  - `dbUtils.saveSetting(key, value)`: 設定保存
  - `dbUtils.loadSettings()`: 設定読み込み（後方互換性対応）
  - `dbUtils.saveChat(chat)`: チャット保存
  - `dbUtils.loadChat(id)`: チャット読み込み
  - `dbUtils.loadAllChats()`: 全チャット読み込み
  - `dbUtils.deleteChat(id)`: チャット削除

- **バージョン管理**:
  - `onversionchange`: 新バージョン検出時にアラート＆リロード
  - マイグレーション: `loadSettings`内で旧設定を新形式に変換

---

### 4.2 エクスポート・インポート

#### 4.2.1 セッションエクスポート・インポート

**要件ID**: DATA-002

**機能概要**:
セッションデータのバックアップと復元。

**詳細仕様**:

- **エクスポート**:
  - 形式: JSON
  - 出力: テキストファイルとしてダウンロード
  - 内容: メッセージ配列全体
  - 一括エクスポート: 全セッションをまとめてエクスポート

- **インポート**:
  - 形式: JSON
  - 入力: ファイル選択またはテキスト貼り付け
  - プレフィックス: 設定によりインポート時に識別子追加
  - 一括インポート: 複数セッションを一度にインポート

**関連設定項目**:
- `addPrefixOnImport`: インポート時にプレフィックス追加（Boolean）

---

#### 4.2.2 設定エクスポート・インポート

**要件ID**: DATA-003

**機能概要**:
設定のバックアップと復元、デバイス間移行。

**詳細仕様**:

- **エクスポート**: 全設定をJSON形式でエクスポート
- **インポート**: JSON形式の設定をインポート

**用途**:
- 設定のバックアップ
- 複数デバイス間での設定共有

---

### 4.3 添付ファイル管理

#### 4.3.1 ファイル添付

**要件ID**: DATA-004

**機能概要**:
画像やファイルをメッセージに添付。

**詳細仕様**:

- **対応ファイル**:
  - 画像: PNG, JPEG, GIF, WEBP等
  - ファイル: テキスト、PDF等（モデル対応による）

- **保存形式**: Base64エンコード
- **保存場所**: メッセージオブジェクト内の`attachments`プロパティ

- **確認ダイアログ**:
  - 添付前に確認ダイアログ表示（設定可能）

- **UI**:
  - 添付ボタン: フッターの「+」ボタン
  - バッジ表示: 添付ファイル数をバッジ表示
  - プレビュー: 添付ファイルのプレビュー表示
  - 削除: 添付ファイル個別削除可能

**関連設定項目**:
- `disableAttachmentConfirmation`: 添付ファイル確認無効化（Boolean）

---

## 5. UI/UX機能

### 5.1 テーマ・カスタマイズ

#### 5.1.1 テーマ

**要件ID**: UI-001

**機能概要**:
アプリケーションの外観をテーマで切り替え。

**詳細仕様**:

- **テーマ一覧**:
  - `light`: ライトモード
  - `dark`: ダークモード
  - `pastel-pink`: パステルピンク
  - `pastel-blue`: パステルブルー
  - `pastel-yellow`: パステルイエロー
  - `pastel-purple`: パステルパープル
  - `pastel-rainbow`: パステルレインボー（グラデーション）

**関連設定項目**:
- `theme`: テーマ（String）

---

#### 5.1.2 背景画像

**要件ID**: UI-002

**機能概要**:
カスタム背景画像を設定。

**詳細仕様**:

- **形式**: Blob（IndexedDB保存）
- **適用**: チャット画面背景

**関連設定項目**:
- `backgroundImageBlob`: 背景画像（Blob）

---

#### 5.1.3 フォント設定

**要件ID**: UI-003

**機能概要**:
フォントファミリーとサイズをカスタマイズ。

**詳細仕様**:

- **フォントファミリー**: カスタムフォント設定
- **フォントサイズ**:
  - メッセージフォントサイズ（1-100px）
  - コードブロックフォントサイズ（1-100px）
  - 思考プロセスフォントサイズ（1-100px）

**関連設定項目**:
- `fontFamily`: フォントファミリー（String）
- `messageBodyFontSize`: メッセージフォントサイズ（Number）
- `codeBlockFontSize`: コードブロックフォントサイズ（Number）
- `thoughtSummaryFontSize`: 思考プロセスフォントサイズ（Number）

---

#### 5.1.4 透明度設定

**要件ID**: UI-004

**機能概要**:
各UI要素の透明度を調整。

**詳細仕様**:

- **対象要素**:
  - メッセージ吹き出し
  - チャットオーバーレイ
  - ヘッダー・フッター
  - メッセージアクション背景
  - 思考プロセス要約

**関連設定項目**:
- `messageBubbleOpacity`: メッセージ吹き出し透明度（0-1）
- `chatOverlayOpacity`: チャットオーバーレイ透明度（0-1）
- `headerFooterOpacity`: ヘッダー・フッター透明度（0-1）
- `messageActionsBackgroundOpacity`: メッセージアクション背景透明度（0-1）
- `thoughtSummaryOpacity`: 思考プロセス要約透明度（0-1）

---

#### 5.1.5 レイアウト調整

**要件ID**: UI-005

**機能概要**:
レイアウトを細かくカスタマイズ。

**詳細仕様**:

- **最小化**: ヘッダー・フッターを最小化
- **吹き出し幅拡張**:
  - AI吹き出し幅拡張
  - ユーザー吹き出し幅拡張
- **間隔縮小**: メッセージ間隔縮小

**関連設定項目**:
- `minimizeHeaderFooter`: ヘッダー・フッター最小化（Boolean）
- `extendAiBubbleWidth`: AI吹き出し幅拡張（Boolean）
- `extendUserBubbleWidth`: ユーザー吹き出し幅拡張（Boolean）
- `reduceMessageSpacing`: メッセージ間隔縮小（Boolean）

---

### 5.2 アイコン・名前表示

#### 5.2.1 ユーザー・AIアイコン

**要件ID**: UI-006

**機能概要**:
ユーザーとAIのアイコンを表示。

**詳細仕様**:

- **ユーザーアイコン**:
  - 表示設定: `showUserIcon`
  - 画像: `userIconBlob`（Blob形式）
  - サイズ: `messageIconSize`（1-300px）
  - Y軸オフセット: `messageIconOffsetY`（-200~200px）

- **AIアイコン**:
  - 表示設定: `showAiIcon`
  - 画像: `aiIconBlob`（Blob形式）
  - サイズ: 共通（`messageIconSize`）
  - Y軸オフセット: 共通（`messageIconOffsetY`）

**関連設定項目**:
- `showUserIcon`: ユーザーアイコン表示（Boolean）
- `userIconBlob`: ユーザーアイコン画像（Blob）
- `showAiIcon`: AIアイコン表示（Boolean）
- `aiIconBlob`: AIアイコン画像（Blob）
- `messageIconSize`: アイコンサイズ（Number, 1-300px）
- `messageIconOffsetY`: アイコンY軸オフセット（Number, -200~200px）

---

#### 5.2.2 ユーザー・AI名表示

**要件ID**: UI-007

**機能概要**:
ユーザーとAIの名前を表示。

**詳細仕様**:

- **ユーザー名**:
  - 表示設定: `showUserName`
  - 名前: `userName`（デフォルト: "あなた"）
  - 吹き出し表示: `showUserNameBubble`
  - 吹き出し色: `userNameBubbleColor`
  - テーマ色使用: `userNameBubbleUseThemeColor`
  - 透明度: `userNameBubbleOpacity`

- **AI名**:
  - 表示設定: `showAiName`
  - 名前: `aiName`（デフォルト: "AI"）
  - 吹き出し表示: `showAiNameBubble`
  - 吹き出し色: `aiNameBubbleColor`
  - テーマ色使用: `aiNameBubbleUseThemeColor`
  - 透明度: `aiNameBubbleOpacity`

- **名前表示設定**:
  - フォントサイズ: `iconNameFontSize`（1-46px）
  - Y軸オフセット: `iconNameOffsetY`（-200~200px）

**関連設定項目**:
- `showUserName`, `userName`, `showUserNameBubble`, `userNameBubbleColor`, `userNameBubbleUseThemeColor`, `userNameBubbleOpacity`
- `showAiName`, `aiName`, `showAiNameBubble`, `aiNameBubbleColor`, `aiNameBubbleUseThemeColor`, `aiNameBubbleOpacity`
- `iconNameFontSize`, `iconNameOffsetY`

---

### 5.3 ボタン・コントロール表示

#### 5.3.1 ヘッダーボタン

**要件ID**: UI-008

**機能概要**:
ヘッダーに表示する各種ボタンの表示/非表示切替。

**詳細仕様**:

- **ボタン一覧**:
  - チャットタイトル
  - 新規チャット
  - セッション削除
  - セッションコピー
  - 上にスクロール
  - 下にスクロール
  - 全メッセージ表示切替
  - メモ
  - クリップボードスタック
  - Twin-Engine要約
  - APIプロバイダー切替

**関連設定項目**:
- `showChatTitle`, `showNewChatButton`, `showDeleteSessionButton`, `showCopySessionButton`, `showScrollToTopButton`, `showScrollToBottomButton`, `showToggleAllContentButton`, `showMemoButton`, `showClipboardStackButton`, `showTwinEngineSummaryButton`, `showApiProviderToggleHeader`

---

#### 5.3.2 フッターボタン

**要件ID**: UI-009

**機能概要**:
フッターに表示する各種ボタンの表示/非表示切替。

**詳細仕様**:

- **ボタン一覧**:
  - 添付ファイル（常時表示）
  - 貼り付け
  - ダイス
  - AI間会話（セッションリンク時に表示）
  - Twin-Engineモード切替
  - 要約実行
  - APIプロバイダー切替

**関連設定項目**:
- `showPasteButtonInFooter`, `showDiceButton`, `showFooterTwinEngineToggleButton`, `showFooterResummarizeButton`, `showApiProviderToggleFooter`

---

### 5.4 その他UI機能

#### 5.4.1 ズーム防止

**要件ID**: UI-010

**機能概要**:
ピンチズームを無効化。

**詳細仕様**:

- **機能**: モバイルデバイスでのピンチズーム操作を無効化
- **用途**: 誤操作防止

**関連設定項目**:
- `preventZoom`: ズーム防止（Boolean）

---

#### 5.4.2 確認ダイアログ無効化

**要件ID**: UI-011

**機能概要**:
各種操作の確認ダイアログを無効化。

**詳細仕様**:

- **対象操作**:
  - 再試行確認
  - メッセージ削除確認
  - 添付ファイル確認
  - 送信中のチャット切替確認
  - 設定保存確認

**関連設定項目**:
- `disableRetryConfirmation`, `disableDeleteMessageConfirmation`, `disableAttachmentConfirmation`, `disableLoadChatConfirmationWhileSending`, `disableSaveSettingsConfirmation`

---

#### 5.4.3 自動保存

**要件ID**: UI-012

**機能概要**:
設定変更時に自動保存。

**詳細仕様**:

- **機能**: 設定画面で変更した内容を自動的にIndexedDBに保存
- **オフ時**: 保存ボタンを明示的にクリックする必要あり

**関連設定項目**:
- `autoSaveSettings`: 自動保存（Boolean）

---

## 6. 高度な機能

### 6.1 Twin-Engine（自動要約）

**要件ID**: ADV-001

**機能概要**:
2つのAPIを使い分け - 1つは会話用、もう1つは要約用。トークン削減のため、履歴を要約して送信。

**詳細仕様**:

- **モード**:
  - 手動: ユーザーが要約ボタンを押す
  - 自動: 指定ターン数を超えたら自動要約

- **要約開始ターン**:
  - 設定: `twinEngineSummarizeAfterTurns`（デフォルト: 3）
  - 説明: ユーザー送信がこの回数を超えたら要約開始

- **要約に含める初期ターン**:
  - 設定: `twinEngineInitialTurnsToInclude`（デフォルト: 1）
  - 説明: セッション初期のユーザーメッセージを要約に含める数

- **要約プロンプト**:
  - 設定: `twinEngineSummaryPrompt`
  - デフォルト: "以下の会話を、重要なポイントを箇条書きで簡潔に要約してください。"

- **API設定**:
  - 複数設定: `twinEngineApiConfigs`配列
  - アクティブ設定: `twinEngineActiveConfigId`
  - 構成:
    ```javascript
    {
      provider: "gemini" | "deepseek" | ...,
      apiKey: "...",
      modelName: "..."
    }
    ```

- **ダミープロンプト**:
  - Dummy User: `twinEngineDummyUser`
  - Dummy Model: `twinEngineDummyModel`
  - 有効化: `twinEngineEnableDummyUser`, `twinEngineEnableDummyModel`
  - 連結: `twinEngineConcatDummyModel`

- **UI**:
  - 要約エリア: `twinEngineSummaryArea`
  - 編集可能: `twinEngineSummaryEditor`（textarea）
  - ボタン:
    - モード切替（自動/手動）
    - APIキー切替
    - 要約コピー
    - 要約全削除
    - 再要約

- **デバッグモード**:
  - 機能: 要約AIに送信されるプロンプトを応答として返す
  - 設定: `dummyTwinEngineDebugMode`

**関連設定項目**:
- `showTwinEngineSettings`, `showTwinEngineSummaryButton`, `showFooterTwinEngineToggleButton`, `showFooterResummarizeButton`, `twinEngineEnableFullAuto`, `twinEngineSummarizeAfterTurns`, `twinEngineInitialTurnsToInclude`, `twinEngineSummaryPrompt`, `twinEngineApiConfigs`, `twinEngineActiveConfigId`, `twinEngineDummyUser`, `twinEngineEnableDummyUser`, `twinEngineDummyModel`, `twinEngineEnableDummyModel`, `twinEngineConcatDummyModel`

---

### 6.2 セッションリンク（AI間会話モード）

**要件ID**: ADV-002

**機能概要**:
2つのセッションをリンクし、AIからAIへメッセージを転送。異なるAI同士の会話を実現。

**詳細仕様**:

- **リンク方法**:
  - UI: 履歴画面でセッションの「リンク」ボタンをクリック
  - 状態: `state.linkedSessionIds`配列で管理
  - 制限: 2つのセッションのみリンク可能

- **AI間会話実行**:
  - ボタン: フッターの「AI間会話」ボタン（👥）
  - 処理フロー:
    1. 現在のセッションでAIの応答を生成（ステップ1/2）
    2. 生成された応答をリンク先セッションに送信（ステップ2/2）
    3. リンク先セッションでAIの応答を生成
  - 状態管理:
    - `isAiToAiChatProcessing`: 処理中フラグ
    - `aiToAiProcessingMessage`: 処理中メッセージ

- **UI表示**:
  - リンクインジケーター: セッションリストでリンク状態を色分け表示
  - `linked-a`: リンクAの色（緑系）
  - `linked-b`: リンクBの色（青系）

**関連設定項目**:
- `enableSessionLinking`: セッションリンク機能有効化（Boolean）
- `showSessionLinkingSettings`: セッションリンク設定表示（Boolean）

---

### 6.3 校正機能

**要件ID**: ADV-003

**機能概要**:
応答生成後に別のモデルで文章を校正。AIの応答をさらに洗練。

**詳細仕様**:

- **プロセス**:
  1. 通常通りAI応答を生成
  2. 成功後、校正用API設定で校正処理を実行
  3. 校正結果でメッセージを更新

- **API設定**:
  - 複数設定: `proofreadingApiConfigs`配列
  - アクティブ設定: `activeProofreadingConfigId`
  - 構成:
    ```javascript
    {
      provider: "...",
      apiKey: "...",
      modelName: "..."
    }
    ```

- **UI**:
  - 設定画面: 校正用API設定リスト
  - 使用中表示: アクティブな設定をハイライト

- **注意点**: 校正処理にもAPIコストが発生

**関連設定項目**:
- `enableProofreading`: 校正機能有効化（Boolean）
- `showProofreadingSettings`: 校正設定表示（Boolean）
- `proofreadingApiConfigs`: 校正用API設定配列
- `activeProofreadingConfigId`: アクティブな校正設定ID

---

### 6.4 思考プロセス表示

**要件ID**: ADV-004

**機能概要**:
AIの内部推論過程を可視化。

**詳細仕様**:

- **対応モデル**:
  - DeepSeek（reasoning content）
  - Gemini（thinking content）
  - Claude（Extended Thinking）
  - xAI（reasoning）
  - LLM Aggregator（モデルによる）

- **実装**:
  - 表示: 応答とは別の領域に思考プロセスを表示
  - 折りたたみ: デフォルトで展開/折りたたみ設定可能
  - スタイル: 背景色を変えて区別
  - 自動スクロール: `autoScrollOnThought`設定で制御

**関連設定項目**:
- `geminiIncludeThoughts`, `geminiExpandThoughtsByDefault`
- `deepSeekIncludeDeepSeekThoughts`, `deepSeekExpandThoughtsByDefault`
- `claudeIncludeThoughts`, `claudeExpandThoughtsByDefault`
- `xaiIncludeThoughts`, `xaiExpandThoughtsByDefault`
- `llmAggregatorIncludeThoughts`, `llmAggregatorExpandThoughtsByDefault`
- `thoughtSummaryOpacity`, `thoughtSummaryFontSize`, `autoScrollOnThought`

---

### 6.5 Geminiプリセット（プロファイル）

**要件ID**: ADV-005

**機能概要**:
Gemini専用の設定プリセット機能。

**詳細仕様**:

- **機能**:
  - プリセット作成: 現在の設定をプリセットとして保存
  - プリセット切替: ヘッダーの「プ」ボタンから選択
  - プリセット管理: 複数のプリセットを保存・切替

- **保存項目**: Gemini関連の全設定（モデル、パラメータ、プロンプト等）

- **UI**:
  - ボタン: `gemini-profile-btn`
  - ドロップダウン: `gemini-profile-dropdown`
  - アクティブ表示: 現在のプリセットをハイライト

**関連設定項目**:
- `geminiPresets`: プリセット配列
- `currentGeminiPresetId`: 現在アクティブなプリセットID

---

## 7. メディア対応

### 7.1 Markdown

**要件ID**: MEDIA-001

**機能概要**:
Markdown形式のテキストをレンダリング。

**詳細仕様**:

- **ライブラリ**: marked.js
- **対応要素**:
  - 見出し（h1-h6）
  - 段落（p）
  - 強調（strong, em）
  - リスト（ul, ol, li）
  - ブロッククォート（blockquote）
  - コードブロック（pre, code）
  - リンク（a）
  - テーブル（table）
  - 水平線（hr）
  - 画像（img）

- **サニタイズ**: DOMPurifyでXSS防止

---

### 7.2 コードブロック

**要件ID**: MEDIA-002

**機能概要**:
コードのシンタックスハイライトとコピー機能。

**詳細仕様**:

- **シンタックスハイライト**: 言語指定に応じた色付け
- **コピーボタン**: 各コードブロックにコピーボタン表示
- **スタイル**: 背景色とフォントサイズをカスタマイズ可能

**関連設定項目**:
- `codeBlockFontSize`: コードブロックフォントサイズ

---

### 7.3 Mermaid図

**要件ID**: MEDIA-003

**機能概要**:
Mermaid形式のダイアグラムを表示。

**詳細仕様**:

- **対応**: Mermaid形式のダイアグラム表示
- **レンダリング**: mermaid.jsライブラリ使用（推測）
- **スタイル**: テーマごとに背景色調整
- **操作**:
  - 折りたたみ: 図の表示/非表示切替
  - コピー: 図のコピー機能

---

### 7.4 画像・ファイル添付

**要件ID**: MEDIA-004

**機能概要**:
画像やファイルをメッセージに添付。

**詳細仕様**:

- **対応形式**:
  - 画像: PNG, JPEG, GIF, WEBP等
  - その他: モデル対応による（PDF等）

- **保存**:
  - 形式: Base64エンコード
  - 場所: メッセージオブジェクトの`attachments`プロパティ

- **UI**:
  - 添付ボタン: フッターの「+」ボタン
  - ダイアログ: ファイル選択ダイアログ
  - プレビュー: 添付ファイルのサムネイル表示
  - 削除: 添付ファイル個別削除可能

- **制限**:
  - モデル対応: Gemini等のマルチモーダルモデルのみ
  - ファイルサイズ: ブラウザ制限に依存

---

## 8. PWA機能

### 8.1 Service Worker

**要件ID**: PWA-001

**機能概要**:
アプリケーションのキャッシングとオフライン対応。

**詳細仕様**:

- **ファイル**: `sw.js`
- **機能**:
  - アプリケーションキャッシング
  - オフライン対応
  - 自動更新通知

- **キャッシュ管理**:
  - `CACHE_NAME`: バージョン管理用
  - 更新: `CACHE_NAME`変更でキャッシュクリア
  - 手動更新: 設定画面から強制更新可能

---

### 8.2 Manifest

**要件ID**: PWA-002

**機能概要**:
PWAとしての定義。

**詳細仕様**:

- **ファイル**: `manifest.json`
- **定義**:
  - アプリ名
  - アイコン
  - テーマカラー
  - 表示モード（standalone等）

---

### 8.3 インストール

**要件ID**: PWA-003

**機能概要**:
ホーム画面への追加とオフライン動作。

**詳細仕様**:

- **対応**: PWAとしてホーム画面に追加可能
- **オフライン**: キャッシュにより一部機能はオフライン動作
- **制限**: API通信は当然オンライン必要

---

## 9. その他の機能

### 9.1 エラーハンドリング

#### 9.1.1 グローバルエラーハンドラー

**要件ID**: OTHER-001

**機能概要**:
アプリケーションの自己修復機能。

**詳細仕様**:

- **機能**: JavaScriptエラーを監視
- **自動復旧**: 1分間に3回エラーが発生するとキャッシュクリア＆リロード
- **目的**: アプリの自己修復

---

#### 9.1.2 API通信エラー

**要件ID**: OTHER-002

**機能概要**:
API通信エラーの処理。

**詳細仕様**:

- **表示**: エラーメッセージをUI表示
- **中断**: `abortController`で通信中断可能
- **再試行**: 再試行ボタンで再実行

---

### 9.2 メモ機能

**要件ID**: OTHER-003

**機能概要**:
一時的なメモを保存。

**詳細仕様**:

- **UI**:
  - エリア: `memoArea`
  - 高さ: `memoHeight`設定（デフォルト300px）
  - 表示切替: ヘッダーボタンで開閉

- **保存**: 内容は未保存（一時的）

**関連設定項目**:
- `showMemoButton`: メモボタン表示（Boolean）
- `memoHeight`: メモエリア高さ（Number）

---

### 9.3 クリップボードスタック

**要件ID**: OTHER-004

**機能概要**:
コピーしたテキストを蓄積。

**詳細仕様**:

- **機能**:
  - 蓄積: コピー操作でテキストをスタックに追加
  - 編集: スタック内容を編集可能
  - コピー: スタック全体をコピー
  - 貼り付け: スタック内容を入力欄に貼り付け
  - 削除: スタック内容を全削除

- **UI**:
  - エリア: `clipboardStackArea`
  - 高さ: `clipboardStackHeight`設定（デフォルト300px）
  - 表示切替: ヘッダーボタンで開閉

**関連設定項目**:
- `showClipboardStackButton`: クリップボードスタックボタン表示（Boolean）
- `clipboardStackHeight`: クリップボードスタックエリア高さ（Number）

---

### 9.4 ダイス機能

**要件ID**: OTHER-005

**機能概要**:
ランダム数値生成。

**詳細仕様**:

- **機能**:
  - 範囲設定: 最小値・最大値を設定
  - 実行: フッターのダイスボタンで実行
  - 結果: 入力欄に挿入

**関連設定項目**:
- `showDiceButton`: ダイスボタン表示（Boolean）
- `diceMinValue`: ダイス最小値（Number）
- `diceMaxValue`: ダイス最大値（Number）

---

### 9.5 Webhook通知

**要件ID**: OTHER-006

**機能概要**:
応答生成完了時に外部Webhookに通知。

**詳細仕様**:

- **設定**:
  - 複数Webhook: `webhooks`配列で複数登録
  - 有効/無効: 各Webhookごとに設定
  - フォーマット: JSON形式またはテキスト形式

- **送信内容**: メッセージ内容、セッション情報等

**関連設定項目**:
- `enableWebhookNotification`: Webhook通知有効化（Boolean）
- `webhooks`: Webhook設定配列

---

### 9.6 設定UI状態保持

**要件ID**: OTHER-007

**機能概要**:
設定画面の開閉状態を記憶。

**詳細仕様**:

- **対象**: 各プロバイダーの設定グループ（details要素）
- **保存**: `settingsUIDetailsOpenStates`
- **目的**: 設定画面の使いやすさ向上

**関連設定項目**:
- `settingsUIDetailsOpenStates`: 設定UI開閉状態（Object）

---

## 10. 非機能要件

### 10.1 セキュリティ

**要件ID**: NFR-001

**機能概要**:
アプリケーションのセキュリティ対策。

**詳細仕様**:

- **APIキー保存**: IndexedDBにローカル保存のみ、サーバー送信なし
- **Content Security Policy**: 外部ドメインをホワイトリスト方式で制限
- **XSS防止**: DOMPurifyでサニタイズ
- **HTTPS**: HTTPは自動的にHTTPSにアップグレード

---

### 10.2 パフォーマンス

**要件ID**: NFR-002

**機能概要**:
アプリケーションのパフォーマンス特性。

**詳細仕様**:

- **大量メッセージ**: 1セッションに大量メッセージがあるとレンダリングが重くなる可能性
- **IndexedDB制限**: ブラウザのストレージ制限に依存

---

### 10.3 互換性

**要件ID**: NFR-003

**機能概要**:
ブラウザ互換性。

**詳細仕様**:

- **ブラウザ依存**: IndexedDB、Service Worker対応ブラウザ必須
- **モバイル**: スワイプナビゲーション等、モバイル最適化機能あり

---

### 10.4 制約事項

**要件ID**: NFR-004

**機能概要**:
既知の制約事項。

**詳細仕様**:

- **ファイル解析**: Gemini等のマルチモーダルモデルのみ対応
- **検索機能**: Gemini Groundingはプロバイダー側機能、他APIでは未対応
- **Claude**: Web fetching機能は未実装
- **OpenAI**: 内部推論フラグ相当の機能なし
- **DeepSeek**: 多くのパラメータが未対応（README参照）
- **オフライン**: API通信は当然オンライン必須、キャッシュで一部UI動作のみ

---

### 10.5 コスト管理

**要件ID**: NFR-005

**機能概要**:
APIコストに関する注意事項。

**詳細仕様**:

- **基本コスト**: 各API呼び出しにコストが発生
- **Twin-Engine**: 2回API呼び出しするため2倍のコスト
- **校正機能**: 追加でコスト発生
- **AI間会話**: 複数回API呼び出し

**推奨事項**:
- 無料モデルで先にテスト
- Dummy AIでUI動作確認
- 設定バックアップを定期的に取得

---

### 10.6 データ管理

**要件ID**: NFR-006

**機能概要**:
データ管理に関する注意事項。

**詳細仕様**:

- **全データがブラウザ内保存**: サーバーにデータは保存されない
- **ブラウザデータ削除でセッション喪失**: ブラウザのデータクリアに注意
- **定期的なエクスポート推奨**: バックアップとして定期的にエクスポート

---

## 付録

### A. 主要なデータフロー

#### A.1 アプリ起動フロー

1. Service Worker登録
2. IndexedDB初期化（`dbUtils.openDB`）
3. 設定読み込み（`dbUtils.loadSettings`）
4. テーマ適用（`uiUtils.updateTheme`）
5. UI初期化
6. 最後に開いていたセッション復元（可能な場合）

---

#### A.2 メッセージ送信フロー

1. ユーザー入力取得
2. 添付ファイルをBase64変換
3. `state.currentMessages`に追加
4. UI更新（`uiUtils.renderChatMessages`）
5. Twin-Engine判定（要約が必要か）
6. API呼び出し（`apiModule`経由）
7. ストリーミング応答受信＆リアルタイム表示
8. 応答完了後、`state.currentMessages`に追加
9. セッション保存（`dbUtils.saveChat`）
10. 校正判定（`enableProofreading`時）
11. Webhook通知送信（`enableWebhookNotification`時）

---

#### A.3 セッション切替フロー

1. 履歴画面でセッション選択
2. 送信中の場合、確認ダイアログ表示（設定による）
3. 現在のセッション保存（未保存の場合）
4. 選択したセッション読み込み（`dbUtils.loadChat`）
5. `state.currentChatId`, `state.currentMessages`更新
6. UI更新（`uiUtils.renderChatMessages`）
7. チャット画面に遷移

---

#### A.4 Twin-Engine要約フロー

1. ターン数チェック（自動モード時）
2. 要約対象メッセージ抽出
3. 初期ターンメッセージを含める（設定による）
4. 要約プロンプト構築
5. Twin-Engine用API呼び出し
6. 要約結果を`state.twinEngineSummaryContent`に保存
7. 次回送信時、要約を履歴として使用

---

#### A.5 AI間会話フロー

1. リンク済み2セッション確認
2. 現在のセッションでAI応答生成（ステップ1）
3. 生成された応答をリンク先セッションのユーザーメッセージとして追加
4. リンク先セッションでAI応答生成（ステップ2）
5. 両セッションを保存
6. UI更新

---

#### A.6 設定保存フロー

1. 設定画面で変更
2. `state.settings`更新
3. 自動保存ON時、即座に保存
4. 自動保存OFF時、保存ボタンクリック
5. 確認ダイアログ表示（設定による）
6. 全設定項目を`dbUtils.saveSetting`経由で保存
7. UI反映（テーマ、フォントサイズ等）

---

### B. 開発・デバッグ機能

#### B.1 Dummy AI

- **errorDebugMode**: エラーメッセージをそのまま応答
- **twinEngineDebugMode**: Twin-Engineプロンプトを応答
- **dummyModel**: 空の応答を返す

#### B.2 その他

- **設定エクスポート**: 設定をJSON形式でエクスポート可能
- **セッションエクスポート**: セッションをJSON形式でエクスポート可能
- **コンソールログ**: エラー・警告をコンソールに出力

---

## 改訂履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|----------|------|---------|-------|
| 1.0 | 2025年 | 初版作成 | - |

---

**以上**
